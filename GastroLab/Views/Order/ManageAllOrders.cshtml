@model IEnumerable<GastroLab.Application.ViewModels.OrderVM>

@{
    ViewData["Title"] = "Manage All Orders";
}

<h1>Manage orders</h1>

<div class="d-flex justify-content-end mb-3 align-items-center">
    <a asp-action="AddOrder" class="btn btn-link text-decoration-none">
        <i class="bi bi-plus-circle"></i> Create New
    </a>
</div>

<div class="table-responsive">
    <table class="table table-striped border">
        <thead>
            <tr>
                <th>Status</th>
                <th>Order Details</th>
                <th>Delivery Info</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in Model)
            {
                <tr>
                    <!-- First Column: Status -->
                    <td>
                        @{
                            string badgeClass = order.Status.ToString() switch
                            {
                                "New" => "text-bg-primary",
                                "InProgress" => "text-bg-warning",
                                "Done" => "text-bg-success",
                                "OnTheWay" => "text-bg-dark",
                                _ => "text-bg-secondary" // Default color for undefined statuses
                            };
                        }
                        <span class="badge rounded-pill @badgeClass">@order.Status</span>
                    </td>

                    <!-- Second Column: Order Details -->
                    <td>
                        @foreach (var product in order.products)
                        {
                            <div>
                                <strong>@product.Quantity x @product.Name</strong>
                                @if (product.ingredients != null && product.ingredients.Any())
                                {
                                    <span>(@string.Join(", ", product.ingredients.Select(i => i.Name)))</span>
                                }
                                @if (product.OrderOptions != null && product.OrderOptions.Any())
                                {
                                    <ul>
                                        @foreach (var optionSet in product.OrderOptions)
                                        {
                                            <li>- @optionSet.Option.Name</li>
                                        }
                                    </ul>
                                }
                            </div>
                        }
                        @if (!string.IsNullOrEmpty(order.Comment))
                        {
                            <p><strong>Note:</strong> @order.Comment</p>
                        }
                    </td>

                    <!-- Third Column: Delivery Info -->
                    <td>
                        <div>
                            <strong>Created on:</strong> @order.CreationDate.ToString("dd.MM.yyyy HH:mm")<br />
                            @{
                                var elapsedTime = DateTime.Now - order.CreationDate;
                                var remainingMinutes = (int)Math.Ceiling(order.WaitingTime - elapsedTime.TotalMinutes);

                                // Ensure remaining minutes are not negative
                                if (remainingMinutes < 0)
                                {
                                    remainingMinutes = 0;
                                }
                                <strong>Remaining time: @remainingMinutes min</strong>

                                <br />
                            }
                            <strong>@order.DeliveryMethod</strong><br />
                            @if (order.DeliveryMethod == GastroLab.Domain.DBO.DeliveryMethod.Delivery && order.Address != null)
                            {
                                var FlatNumber = order.Address.FlatNumber != null ? "/" + order.Address.FlatNumber : "";
                                <p>@order.Address.City @order.Address.Street @order.Address.HouseNumber@FlatNumber</p>
                            }
                            else if (order.DeliveryMethod == GastroLab.Domain.DBO.DeliveryMethod.DineIn)
                            {
                                <p>Table: @order.TableNr</p>
                            }
                            else // Pickup
                            {
                                <p>
                                    Pickup time: @(
                            order.ScheduledDeliveryDate.HasValue
                            ? order.ScheduledDeliveryDate.Value.ToString("dd.MM.yyyy HH:mm")
                            : (order.CreationDate + (TimeSpan.FromMinutes(order.WaitingTime))).ToString("dd.MM.yyyy HH:mm")
                            )
                                </p>
                            }
                        </div>
                    </td>

                    <!-- Fourth Column: Total Price and Edit/Delete buttons -->
                    <td>
                        <div>
                            <strong>Total Price:</strong> @order.TotalPrice.ToString("F2") zł
                        </div>
                        <div class="mt-2">
                            <a asp-action="EditOrder" asp-route-id="@order.Id" class="btn btn-sm btn-warning me-2">
                                <i class="bi bi-pencil-square" aria-hidden="true"></i> <span class="visually-hidden">Edit Order</span> Edit
                            </a>
                            <a asp-action="DeleteOrder" asp-route-id="@order.Id" class="btn btn-sm btn-danger">
                                <i class="bi bi-trash3" aria-hidden="true"></i> <span class="visually-hidden">Delete Order</span> Delete
                            </a>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>
